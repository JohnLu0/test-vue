<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../jsui/themes/default/easyui.css" rel="stylesheet" type="text/css" />
    <link href="../jsui/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../jsui/jquery-1.4.1.min.js" type="text/javascript"></script>
    <script src="../jsui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../jsui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <script src="../jsui/json.js" type="text/javascript"></script>
    <script type="text/javascript">
        var temp="<tr><td align='center' class='style12' >#sbu</td><td align='center' class='style10'><input type='text' style='width: 110px' value='#jin' /></td><td align='center' class='style10' ><input type='text' style='width: 110px' value='#li' /></td><td align='center' class='style10' >#zai</td></tr>";
        var permis = new Object();
        var date = new Object();
        var parParam = new Object();
        var changqu = new Object();
        var stat = new Object();
        var cccc = new Array();
        var stat1 = false;
        $(function () {
            var d = new Date();
            var LINT_YYYY = d.getFullYear();
            var LINT_MM = d.getMonth();
            var LINT_DD = d.getDate();
            var uom = new Date(LINT_YYYY, LINT_MM, LINT_DD);
            uom.setDate(uom.getDate() - 1);
            var vMon = uom.getMonth();
            vMon++;
            if (vMon < 10) {
                vMon = "0" + vMon;
            }
            var vDate = uom.getDate();
            if (vDate < 10) {
                vDate = "0" + vDate;
            }
            var vYear = uom.getFullYear();
            var date = vYear + '-' + vMon + '-' + vDate;
            var dat = vYear + '-' + vMon + '-' + vDate;
            parParam.date = date;
            parParam.dat = dat;
            $('#dd').datebox({
                onSelect: function (date) {
                    if (date > uom) {
                        alert("日期不能大於等於當前日期！");
                        $('#dd').datebox('setValue', '重新選擇');
                    }
                    else {
                        dat = $("input[name='dd']").val();
                        parParam.dat = dat;
                    }
                }
            });
            permis = $("#permis", parent.document).text();
            changqu = $("#area", parent.document).text();
            //changqu = '淮安';
            //permis = 'admin';
            parParam.changqu = changqu;
            parParam.dat = dat;
            if (permis == 'admin') {
                $("#p").hide();
                parParam.mode = "load";
                $('#part').datagrid({
                    loadMsg: '数据加载中请稍后……',
                    title: '相親相愛聯防排查表',
                    iconCls: 'icon-edit',
                    loadMsg: "loading",
                    striped: true,
                    fit: true, //大小自适应
                    fitColumns: true,
                    pagination: true, //分页控件
                    collapsible: true, //是否可折叠
                    singleSelect: true, //是否单选
                    queryParams: parParam,  //參數
                    idField: 'itemid',
                    rownumbers: true, //行数
                    showFooter: true,
                    url: "sum.ashx",
                    style: "table-layout:fixed;word-break:break-all;word-wrap:break-word;",
                    columns: [[
                        { field: 'changqu', title: '廠區', rowspan: 2, width: 30, align: 'center', editor: 'text' },
                        { field: 'zaizhi', title: '總人力<br />A', rowspan: 2, width: 20, align: 'center', editor: 'text' },
                        { title: '今日出勤狀況（人數）', colspan: 6 },
                        { field: 'lizhi', title: '昨日<br />離職<br />g', width: 20, rowspan: 2, align: 'center', editor: 'text' },
                        { field: 'diaochu', title: '昨日<br />調出', width: 20, rowspan: 2, align: 'center', editor: 'text' },
                        { field: 'xinjing', title: '今日<br />新進', width: 20, rowspan: 2, align: 'center', editor: 'text' },
                        { field: 'diaoru', title: '今日<br />調入', width: 20, rowspan: 2, align: 'center', editor: 'text' },
                        { title: '聯防狀態', colspan: 2 },
                        { field: 'yichang', title: '描述', width: 60, rowspan: 2, align: 'center', editor: 'text' }
                        ], [
					    { field: 'zaigang', title: '正常<br />出勤', width: 20, align: 'center', editor: 'text' },
					    { field: 'changjia', title: '長假<br />b', width: 20, align: 'center', editor: 'text' },
					    { field: 'shijia', title: '事假<br />c', width: 20, align: 'center', editor: 'text' },
                        { field: 'bingjia', title: '病假<br />d', width: 20, align: 'center', editor: 'text' },
                        { field: 'tiaoxiu', title: '調休<br />e', width: 20, align: 'center', editor: 'text' },
					    { field: 'kuanggong', title: '曠工<br />f', width: 20, align: 'center', editor: 'text' },
                        { field: 'zhuangtai', title: '正常<br />h', width: 20, align: 'center', editor: 'text',
                            formatter: function (value, row, index) {
                                if (value == '正常') {
                                    return 'V';
                                } else {
                                    return '';
                                }
                            }

                         },
                        { field: 'zhuangtai1', title: '異常<br />j', width: 20, align: 'center', editor: 'text',
                            formatter: function (value, row, index) {
                                if (value == '異常') {
                                    return 'V';
                                } else {
                                    return '';
                                }
                            }

                         }
				    ]],
                    onLoadSuccess: function (data) {
                        $('#part').datagrid('options').queryParams = parParam;
                    },
                    onBeforeEdit: function (index, row) {
                        row.editing = true;
                        updateActions(index, row);
                    },
                    onAfterEdit: function (index, row) {
                        row.editing = false;
                        updateActions(index, row);
                    },
                    onCancelEdit: function (index, row) {
                        row.editing = false;
                        updateActions(index, row);
                    }
                });
                var p = $('#part').datagrid('getPager');
                $(p).pagination({
                    pageSize: 10,
                    pageList: [10, 20, 30],
                    beforePageText: '第',
                    afterPageText: '页    共{pages} 页',
                    displayMsg: '当前显示 {from} - {to} 条记录   共 {total} 条记录'
                });
                $('#part').datagrid('reload');
            }
            else {
                $('#p').panel({
                    title: '每日信息維護'
                });
                $('#q').panel({
                    width: 420,
                    height: 500,
                    title: '每日信息維護',
                    tools: [{
                        iconCls: 'icon-save',
                        handler: function () {

                        }
                    }]
                });
                var G1 = [{ ID: '正常', TEXT: '正常' }, { ID: '異常', TEXT: '異常'}];
                $("#zhuangtai").combobox({
                    editable: false,
                    data: G1,
                    valueField: 'ID',
                    textField: 'TEXT',
                    panelHeight: 'auto'
                });
                $("#p input:not(.yichang)").keypress(function (event) {
                    var eventObj = event || e;
                    var keyCode = eventObj.keyCode || eventObj.which;
                    if ((keyCode >= 48 && keyCode <= 57))
                    { return true; }
                    else {
                        alert("只能输入数字");
                        return false;
                    }
                }).focus(function () {
                    //禁用输入法
                    this.style.imeMode = 'disabled';
                }).bind("paste", function () {
                    //获取剪切板的内容
                    var clipboard = window.clipboardData.getData("Text");
                    if (/^\d+$/.test(clipboard))
                    { return true; }
                    else {
                        alert("只能输入数字");
                        return false;
                    }
                });
                parParam.mode = "qushu";
                $.post("sum.ashx",
                parParam,
                function (data, status) {
                    data = eval("(" + data + ")");
                    stat = data[0].qushu;
                    ssu = data[2].qushu1;
                    if (stat == "NG") {
                        $("#zaizhi").val(data[1].zaizhi);
                        $("#changjia").val('0');
                        $("#shijia").val('0');
                        $("#bingjia").val('0');
                        $("#tiaoxiu").val('0');
                        $("#kuanggong").val('0');
                        $("#lizhi").val('0');
                        $("#diaochu").val('0');
                        $("#xinjing").val('0');
                        $("#diaoru").val('0');
                    }
                    else {
                        $("#zaizhi").val(data[1].zaizhi);
                        $("#changjia").val(data[1].changjia);
                        $("#shijia").val(data[1].shijia);
                        $("#bingjia").val(data[1].bingjia);
                        $("#tiaoxiu").val(data[1].tiaoxiu);
                        $("#kuanggong").val(data[1].kuanggong);
                        $("#lizhi").val(data[1].lizhi);
                        $("#diaochu").val(data[1].diaochu);
                        $("#xinjing").val(data[1].xinjing);
                        $("#zhuangtai").combobox('setValue', data[1].zhuangtai);
                        $("#yichang").val(data[1].yichang);
                        $("#zaigang").val(data[1].zaigang);
                        $("#diaoru").val(data[1].diaoru);
                    }
                    $.each(data, function (n, value) {
                        if (n > 2) {
                            temp1 = temp;
                            temp1 = temp1.replace("#sbu", value.sbu);
                            temp1 = temp1.replace("#jin", value.jin);
                            temp1 = temp1.replace("#li", value.li);
                            temp1 = temp1.replace("#zai", value.zai);
                            cccc[n - 3] = data[n];
                            $('#mingxi').find('tr:last-child').after(temp1);
                        }
                    });

                    $("#mingxi input").keypress(function (event) {
                        var eventObj = event || e;
                        var keyCode = eventObj.keyCode || eventObj.which;
                        if ((keyCode >= 48 && keyCode <= 57))
                        { return true; }
                        else {
                            alert("只能输入数字");
                            return false;
                        }
                    }).focus(function () {
                        //禁用输入法
                        this.style.imeMode = 'disabled';
                    }).bind("paste", function () {
                        //获取剪切板的内容
                        var clipboard = window.clipboardData.getData("Text");
                        if (/^\d+$/.test(clipboard))
                        { return true; }
                        else {
                            alert("只能输入数字");
                            return false;
                        }
                    });
                });
            }
        });
        function part_search() {
            $("#zaizhi").val("0");
            $("#changjia").val("0");
            $("#shijia").val("0");
            $("#bingjia").val("0");
            $("#tiaoxiu").val("0");
            $("#kuanggong").val("0");
            $("#lizhi").val("0");
            $("#diaochu").val("0");
            $("#xinjing").val("0");
            $("#yichang").val("");
            $("#zaigang").val("");
            if (permis == "admin") {
                var qname1 = $("#part_Text1").val();
                $($('#part').datagrid('getPager')).pagination({ pageNumber: 1 });
                parParam.mode = 'load';
                $('#part').datagrid('options').queryParams = parParam;
                $("#part").datagrid('reload');
            }
            else {
                parParam.mode = "qushu";
                $.post("sum.ashx",
                parParam,
                function (data, status) {
                    data = eval("(" + data + ")");
                    stat = data[0].qushu;
                    if (stat == "NG") {
                        $("#zaizhi").val(data[1].zaizhi);
                    }
                    else {
                        $("#zaizhi").val(data[1].zaizhi);
                        $("#changjia").val(data[1].changjia);
                        $("#shijia").val(data[1].shijia);
                        $("#bingjia").val(data[1].bingjia);
                        $("#tiaoxiu").val(data[1].tiaoxiu);
                        $("#kuanggong").val(data[1].kuanggong);
                        $("#lizhi").val(data[1].lizhi);
                        $("#diaochu").val(data[1].diaochu);
                        $("#xinjing").val(data[1].xinjing);
                        $("#zhuangtai").combobox('setValue', data[1].zhuangtai);
                        $("#yichang").val(data[1].yichang);
                        $("#zaigang").val(data[1].zaigang);
                    }
                    $("#mingxi tr").eq(1).nextAll().remove();
                    $.each(data, function (n, value) {
                        if (n > 2) {
                            temp1 = temp;
                            temp1 = temp1.replace("#sbu", value.sbu);
                            temp1 = temp1.replace("#jin", value.jin);
                            temp1 = temp1.replace("#li", value.li);
                            temp1 = temp1.replace("#zai", value.zai);
                            cccc[n - 3] = data[n];
                            $('#mingxi').find('tr:last-child').after(temp1);
                        }
                    });
                });
            }
        }
        function part_yunsuan() {
            parParam.zhuangtai = $("#zhuangtai").combobox('getText');
            parParam.zaizhi = $("#zaizhi").val();
            parParam.changjia = $("#changjia").val();
            parParam.shijia = $("#shijia").val();
            parParam.bingjia = $("#bingjia").val();
            parParam.tiaoxiu = $("#tiaoxiu").val();
            parParam.kuanggong = $("#kuanggong").val();
            parParam.lizhi = $("#lizhi").val();
            parParam.diaochu = $("#diaochu").val();
            parParam.xinjing = $("#xinjing").val();
            parParam.yichang = $("#yichang").val();
            parParam.diaoru = $("#diaoru").val();
            parParam.fudu = parseInt(parParam.xinjing) - parseInt(parParam.lizhi) - parseInt(parParam.diaochu);
            var stat99 = false;
            if (parParam.zhuangtai == "異常") {
                if (parParam.zaizhi == "" || parParam.changjia == "" || parParam.shijia == "" || parParam.bingjia == "" || parParam.tiaoxiu == "" || parParam.kuanggong == "" || parParam.lizhi == "" || parParam.diaochu == "" || parParam.xinjing == "" || parParam.zhuangtai == "" || parParam.yichang == "") {
                        alert("除'正常出勤外，其他不能為空！'");
                    }
                    else {
                        parParam.zaigang = parParam.zaizhi - parParam.changjia - parParam.shijia - parParam.bingjia - parParam.tiaoxiu - parParam.kuanggong - parParam.lizhi - parParam.diaochu + parParam.xinjing;
                        $("#zaigang").val(parParam.zaigang);
                        stat99 = true;
                    }
            }
            else {
                if (parParam.zaizhi == "" || parParam.changjia == "" || parParam.shijia == "" || parParam.bingjia == "" || parParam.tiaoxiu == "" || parParam.kuanggong == "" || parParam.lizhi == "" || parParam.diaochu == "" || parParam.xinjing == "" || parParam.zhuangtai == "") {
                    alert("除'正常出勤和異常描述外，其他不能為空！'");
                }
                else {
                    parParam.zaigang = parseInt(parParam.zaizhi) - parseInt(parParam.changjia) - parseInt(parParam.shijia) - parseInt(parParam.bingjia) - parseInt(parParam.tiaoxiu) - parseInt(parParam.kuanggong) - parseInt(parParam.lizhi) - parseInt(parParam.diaochu) + parseInt(parParam.xinjing);
                    $("#zaigang").val(parParam.zaigang);
                    parParam.yichang = "無";
                    stat99 = true;
                }
            }
            var jin = 0;
            var li = 0;
            var li1 = 0;
            var jin1 = 0;
            if (stat99) {
                $("#mingxi td:nth-child(2)").find('input').each(function () {
                    jin = parseInt(jin) + parseInt($(this).val());
                });
                $("#mingxi td:nth-child(3)").find('input').each(function () {
                    li = parseInt(li) + parseInt($(this).val());
                });
                li1 = parseInt(parParam.lizhi) + parseInt(parParam.diaochu);
                jin1 = parseInt(parParam.xinjing) + parseInt(parParam.diaoru);
                if (li == li1 && jin == jin1) {
                    var rowIndex = 2;
                    var i = 0;
                    var cccc0 = 0;
                    var cccc1 = 0;
                    var cccc2 = 0;
                    var cccc3 = 0;
                    var cccc00 = 0;
                    var cccc11 = 0;
                    var cccc22 = 0;
                    $("#mingxi td:nth-child(3)").find('input').each(function () {
                        cccc0 = $("#mingxi tr:eq(" + rowIndex + ") td:eq(1) input").val();
                        cccc1 = $(this).val();
                        cccc2 = $("#mingxi tr:eq(" + rowIndex + ") td:eq(3)").text();
                        cccc00 = parseInt(cccc0) - parseInt(cccc[i].jin);
                        cccc11 = parseInt(cccc1) - parseInt(cccc[i].li);
                        cccc[i].jin = cccc0;
                        cccc[i].li = cccc1;
                        cccc3 = parseInt(cccc00) - parseInt(cccc11);
                        cccc2 = parseInt(cccc2) + parseInt(cccc3);
                        cccc[i].zai = cccc2;
                        cccc[i].liu = cccc3;
                        $("#mingxi tr:eq(" + rowIndex + ") td:eq(3)").text(cccc2);
                        rowIndex++;
                        i++;
                    });
                    stat1 = true;
                    alert("運算成功！");
                }
                else {
                    alert("明细和汇总对不上，运算失败，请检查！");
                }
            }
        }
        function part_yunsuan1() {
            if (stat1) {
                parParam.mode = "baocun";
                parParam.table = JSON.stringify(cccc);
                $.post("sum.ashx",
                                parParam,
                                function (data, status) {
                                    if (data == "OK") {
                                        stat1 = false;
                                        alert("保存成功！");
                                    }
                                    if (data == "NG") {
                                        alert("保存失敗！");
                                    }
                                    if (data == "NN") {
                                        alert("保存異常，請聯繫系統管理員！");
                                    }
                                });
            }
            else {
                alert("沒有運算成功，不能保存");
            }
        }
    </script>
    <style type="text/css">
        #cardno
        {
            width: 114px;
        }
        .yichang
        {
            width: 336px;
        }
        #xinjing
        {
            width: 147px;
            margin-left: 2px;
        }
        
        #Text1
        {
            width: 91px;
        }
 
        #Text2
        {
            width: 68px;
        }

        .style9
        {
            height: 23px;
        }
       
        .style11
        {
            width: 78px;
        }
               
        #diaochu
        {
            width: 97px;
        }
               
        #xinjing0
        {
            width: 147px;
            margin-left: 2px;
        }
        
        </style>
</head>
<body style="height:500px">
<br />
    <div>
    日期：<input id="dd" name="dd" type="text" class="easyui-datebox" editable=false/>&nbsp;&nbsp;
    <a href="javascript:part_search()" class="easyui-linkbutton" >查询</a>
    </div>
    <br />
<table id="part"></table>
<div id="p" style="padding:10px; width: 500px;"> 
        <br />    
        前一次總人力：<input id="zaizhi" type="text" style="color:Red" readonly="readonly" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="javascript:part_yunsuan()" class="easyui-linkbutton" >先運算</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a class="easyui-linkbutton" href="javascript:part_yunsuan1()">后保存</a><br />
         長假：<input id="changjia" type="text"  />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
         事假：<input id="shijia" type="text" />
        <br />
         病假：<input id="bingjia" type="text" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
         調休：<input id="tiaoxiu" type="text" />
        <br />
         曠工：<input id="kuanggong" type="text" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
         離職：<input id="lizhi" type="text" />
        <br />
         非正常離職：<input id="diaochu" type="text" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 新進：<input id="xinjing" type="text" />
        <br />
        <br />
        调入：<input id="diaoru" type="text" /><br />
        <br />
        聯防狀態：<input id="zhuangtai" type="text" readonly="readonly"/>
        <br />
        <br />
        異常描述：<input id="yichang" class="yichang" type="text" />
        <br />
        <br />
        正常出勤：<input id="zaigang" type="text" style="color:Red" readonly="readonly" />
        <br />
        <br />
        <table id="mingxi" width=450px border="1" cellspacing="0" cellpadding="0">
            <tr>
            <td align="center" colspan='4' class="style9">&nbsp;新進調入&nbsp; 離職調出&nbsp; 明細</td>
            
            </tr>
            <tr>
                <td align="center" class="style11" >
                    SBU</td>
                <td align="center" >
                    新進調入</td>
                <td align="center">
                    離職<br />
                    非正常離職</td>
                <td align="center">
                        在職人員</td>
            </tr>
            
        </table>
        </div>
        
</body>
</html>
